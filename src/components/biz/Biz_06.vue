<template>
  <div class="page plain">
    <div class="left-title">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        viewBox="0 0 108.87 20.39"
      >
        <defs>
          <filter
            id="luminosity-invert_left-title"
            filterUnits="userSpaceOnUse"
            color-interpolation-filters="sRGB"
          >
            <feColorMatrix values="-1 0 0 0 1 0 -1 0 0 1 0 0 -1 0 1 0 0 0 1 0" />
          </filter>
          <mask
            id="mask_left-title"
            x="-2.67"
            y="-2.83"
            width="114"
            height="26"
            maskUnits="userSpaceOnUse"
          >
            <g class="cls-5">
              <image
                width="114"
                height="26"
                transform="translate(-2.67 -2.83)"
                xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHIAAAAaCAYAAABreghKAAAACXBIWXMAAAsSAAALEgHS3X78AAAE7klEQVRoQ+2a4ZKjKhCFG9Qk8/6PajQqaPbH3MM9dhrRjLs1UzWniqJFowyfpwF3nYg85Vc/Xr50wa9+hmo+cM6Jc0689ym2Cq61ah1vtR3Vu/d4Pr+edHL34HYrtmp9ndW29Rs+Bzn5L7U656SqKqnrWpqmkbqupa5rqapKqqoS730CnAON+3j/v9H/BeAzdQTYsiyrYx5wBsRlWRaznudZlmV5KXwNx7pPyZHOOanrWm63m9xuN7lcLiugdV2L9z4LVcPFPXMgvxNUC17OAVvQeMBz0LjEGFM8z3OCiTjGmGq0Y4x0/xJI7700TZNA3m43uV6v0jRNKpZD9ziVwUIlqHvOvSMLmnXOii14e6FpYBrWPM8SQljB895LCCE9gyFmQcKRTdPI9XqVj4+PBJPd2TTNCiZqBllVVdaZuZr7sVe5a7dgaZWch/hdgHAZAwOoGGOCB3AMb1mW1dhZAKEsSMAESLgTabZpmpdUy+4EWMyXe91pHWuVzkMloDmIHGuI1nyVA2i5T8OrqkqmaVrBmuc5jaOIrO6bg7kCCTCACYCcZi+Xy8tCCPPnnjSLZ1m1jlm8gHpHy7KY7Tl4uraK5UILIKfNEMIKHv8+xrgCqu+H51kyQfLqFe4EVIAszZmcXo/CtI73nmNtOTLnxr0Q53kuOhGuQ9rkfuN6zlp4Hu4TQljNm1t/z8s+EmAAE+VyuaS5kl0JmPwSsCO1M/Gcd0EedeYeJ/KxBsgxu3CPE/lvx31w7Ra8GKNM0yTTNEkIoQhRZOODgHYngPGiB20MMzdf8r35WYi5D7pPZyoHkGOGyOAYJNcaGoPDNRZU/j3S7jRNMo6jDMMg4zimrUdJJkgedAZrFe1IDdECys9CzH3QOgum9VZbTkT9fD7Fe5/ief7cxz2fn1sBPcBVVSU4/Pfx/SyAcN8wDDIMg3RdJ8MwpHlxj1YgLVmDvHewcwD2tpcAWue3UhC7gdsAhms+p6/V4jb9IgAap2C4L4Qg4zjKOI7yeDzk8XjI/X6Xx+MhMcaX52xpBVK/NegEd8bqmH77WDxAOr3scWQJ5lFpEFsQEFvpNAcIMbex8wAPKXQcR+n7/ksQRTIg0Tl0LMYodV2nyRgw+A1/Pp/F+VH/Tte8AOD2s8XwOHUxPNSlF5vHSq9UkTIBjeENwyB936fStq30ff8WRBEDpF558SbWWmlhQYTNrXNu9bXnCEgdb7UdlXaibrMgorZAwnXsSE6bevECeEihXddJ3/dyv9+lbVvpuu5tiCIEEp3kDk3TlOBAnDK2VqzOlbce/GKUYO45p2XBy53DMRx61JU6jfIcCJgMses6adtW2raV+/3+JYgiGZDoAADh/DzPq090uY8BgGjNiVtutI5L7XuUA5qDWXIl9nU6vcIE2pHYSnA6PROiiALJbxGciI6HENK/gvBHAwaoPwZ8B4jQ2TCtFIuY50iMJ9IqgzwLoogCqdMp2vhrDgPM7RuPALQgnQGuJAsst+VAIgZIxLxSZWfyHhEgMT+eBVGEQOJNGsdRnPvc7O5x4U8DqPUVoAyT3akXijqt4rPbmXIi+f/qUZoHuaAN9+Jax9ZxTnuv26NcetXKpVuOLaB6EcSLRsA804WsBFJEXqAg5nNc0M61jrfaSnrnNyXthck64louWAHDoTj+G1qB/NXP1bF/E/rVt9UfnzpZavIn+JQAAAAASUVORK5CYII="
              />
            </g>
          </mask>
        </defs>
        <path
          class="cls-1"
          d="M87.74,20.39H.64c-.64,0-.58-1-.58-1L0,.41A1.22,1.22,0,0,1,.87,0h107c1.12,0,1.37,1.19.27,2.22L88,20.26A.41.41,0,0,1,87.74,20.39Z"
        />
        <g class="cls-2">
          <g class="cls-3">
            <path
              class="cls-4"
              d="M87.74,20.39H.64c-.64,0-.58-1-.58-1L0,.41A1.22,1.22,0,0,1,.87,0h107c1.12,0,1.37,1.19.27,2.22L88,20.26A.41.41,0,0,1,87.74,20.39Z"
            />
          </g>
        </g>
      </svg>
      <span>厂区位置</span>
    </div>

    <div class="header">
      <Biz_06_Header />
    </div>
    
    <div class="body">
      <!-- <iframe class="iframe" src="/3d/" frameborder="0"></iframe> -->
    </div>

    <div class="footer">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        viewBox="0 0 283.19 34.58"
      >
        <defs>
          <linearGradient
            id="linear-gradient_Biz_06_2"
            x1="49.22"
            y1="0.58"
            x2="235.22"
            y2="0.58"
            gradientUnits="userSpaceOnUse"
          >
            <stop offset="0" stop-color="#14beff" stop-opacity="0" />
            <stop offset="0.05" stop-color="#1abfff" stop-opacity="0.05" />
            <stop offset="0.13" stop-color="#2ac2ff" stop-opacity="0.19" />
            <stop offset="0.25" stop-color="#45c7ff" stop-opacity="0.41" />
            <stop offset="0.39" stop-color="#69ceff" stop-opacity="0.71" />
            <stop offset="0.52" stop-color="#8bd4ff" />
            <stop offset="0.58" stop-color="#7dd1ff" stop-opacity="0.88" />
            <stop offset="0.73" stop-color="#5acbff" stop-opacity="0.59" />
            <stop offset="0.95" stop-color="#22c1ff" stop-opacity="0.12" />
            <stop offset="1" stop-color="#14beff" stop-opacity="0" />
          </linearGradient>
        </defs>
        <path
          style="fill: #070e16;opacity: 0.7;"
          d="M0,34.58,18.06,7C20.86,2.66,26.2,0,32,0H251.32c5.81,0,11.16,2.68,13.95,7l17.92,27.59Z"
        />
        <line
          style="fill: none;stroke-miterlimit: 10;opacity: 0.9;stroke: url(#llinear-gradient_Biz_06_2);"
          x1="49.22"
          y1="0.58"
          x2="235.22"
          y2="0.58"
        />
      </svg>
      <ul class="footer-items">
        <li class="footer-item" @click="currentMenu=1" :class="{active:currentMenu==1}">
          <i class="iconfont icon-ship"></i>
          <span>修船业务</span>
        </li>
        <li class="footer-item" @click="currentMenu=2" :class="{active:currentMenu==2}">
          <i class="iconfont icon-kangtai"></i>
          <span>抗台指挥</span>
        </li>
      </ul>
    </div>

    <div class="chaogao" :style="showBox?'z-index:3':''">
      <div class="liquid" ref="liquid" @click="showBox=true"></div>
      <transition name="el-zoom-in-center">
        <div class="box" v-show="showBox">
          <div class="left">
            <div class="title">当天潮汐变化情况统计</div>
            <ul>
              <li v-for="(i,index) in chaoList" :key="index">
                <i class="iconfont" :class="i.icon"></i>
                <span class="text-primary">{{i.name}}</span>
                <span class="text-info">{{i.time}}</span>
                <span class="text-info">{{i.value}}m</span>
              </li>
            </ul>
          </div>
          <div class="center">
            <div ref="line" class="chart"></div>
          </div>
          <div class="right"></div>
          <div class="close-btn" @click="showBox=false">
            <i class="iconfont iconziyuan4"></i>
          </div>
        </div>
      </transition>
    </div>

    <div class="resize-btn" @click="resize">
      <i class="iconfont" :class="Map3d_Max?'iconzu4':'iconzu2'"></i>
    </div>

    <div class="time-box">
      <span class="text-info">{{currentTime | time('yyyy-MM-dd')}}</span>
      <span class="text-info">{{currentTime | time('hh:mm')}}</span>
      <span class="text-info">{{currentTime | week}}</span>
    </div>

    <Biz_06_1 />
  </div>
</template>

<script>
/**
 * 3D地图
 */
import echarts from "echarts";
import "echarts-liquidfill";
import { mapState } from "vuex";
import { getTide } from "@/api";
import Biz_06_Header from "./Biz_06_Header.vue";

export default {
  components: {
    Biz_06_Header,
  },

  filters: {
    week(val) {
      return {
        0: "周日",
        1: "周一",
        2: "周二",
        3: "周三",
        4: "周四",
        5: "周五",
        6: "周六",
      }[new Date(val).getDay()];
    },
  },

  data() {
    return {
      currentTime: new Date(),

      currentMenu: 2,

      liquid: {
        instance: null,
        option: {
          backgroundColor: "",

          graphic: [
            {
              type: "text",
              z: 100,
              left: "center",
              bottom: "30%",
              style: {
                fill: "#fff",
                text: "当前浪高",
                font: "12px Microsoft YaHei",
              },
            },
          ],

          series: [
            {
              type: "liquidFill",
              radius: "60%",
              center: ["50%", "50%"],
              data: [],
              backgroundStyle: {
                borderWidth: 0,
                //borderColor: 'red',
                color: "transparent",
              },
              itemStyle: {
                color: "rgb(18,97,214)",
              },

              outline: {
                show: true,
                borderDistance: 3,
                itemStyle: {
                  color: "none",
                  borderColor: "rgb(26,110,211)",
                  borderWidth: 3,
                  shadowBlur: 20,
                  shadowColor: "rgba(0, 0, 0, 0.25)",
                },
              },

              label: {
                normal: {
                  formatter: "1.2m",
                  textStyle: {
                    fontSize: 20,
                    color: "#fff",
                  },
                },
              },
            },
          ],
        },
      },

      chaogao: {},

      vm: {
        overview: [],
      },

      line: {
        instance: null,

        option: {
          tooltip: {
            trigger: "axis",
            axisPointer: {
              type: "cross",
              label: {
                backgroundColor: "rgba(0,0,0,.3)",
              },
            },
          },
          grid: {
            top: "30%",
            left: "5%",
            right: "5%",
            bottom: "0%",
            containLabel: true,
          },
          xAxis: [
            {
              type: "category",
              boundaryGap: false,
              data: (function () {
                const arr = [];

                for (let i = 0; i < 24; i++) {
                  arr.push(i + "");
                }
                return arr;
              })(),
              axisLabel: {
                color: "rgb(202,231,255)",
              },
              axisTick: {
                show: false,
              },
            },
          ],
          yAxis: [
            {
              name: "浪高",
              type: "value",
              nameTextStyle: {
                color: "rgb(202,231,255)",
                fontSize: 10,
              },
              axisLabel: {
                color: "rgb(202,231,255)",
                fontSize: 10,
              },
              axisTick: {
                show: false,
              },
              axisLine: {
                lineStyle: {
                  color: "rgb(67,108,139)",
                },
              },
              splitLine: {
                lineStyle: {
                  color: "rgba(103,134,154,.7)",
                  type: "dashed",
                },
              },
            },
          ],
          series: [
            {
              name: "浪高",
              type: "line",
              color: "rgb(59,148,255)",
              areaStyle: {
                normal: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    {
                      offset: 0,
                      color: "rgba(59,148,255,0.6)",
                    },
                    {
                      offset: 1,
                      color: "rgba(59,148,255,0)",
                    },
                  ]),
                },
              },
              smooth: true,
              data: [],
            },
          ],
        },
      },

      showBox: false,

      currentHour: 0,
    };
  },

  watch: {
    showBox(val) {
      if (val === true) {
        this.$nextTick(() => {
          this.line.instance.resize();
        });
      }
    },
  },

  methods: {
    refresh() {
      getTide().then((data) => {
        try {
          this.vm = JSON.parse(data.data).data;

          const currentHour =
            new Date().getMinutes() >= 30
              ? new Date().getHours() + 1
              : new Date().getHours();

          this.currentHour = currentHour < 24 ? currentHour : 0;

          this.refreshLiquid();
          this.refreshLine();
        } catch (error) {
          console.log(error);
        }
      });
    },

    refreshLiquid() {
      let value = 0;

      try {
        value = this.vm.detail[0]["h" + this.currentHour];
      } catch (error) {
        console.log(error);
      }

      this.liquid.option.series[0].data = [value / 10];
      this.liquid.option.series[0].label.normal.formatter = `${value}m`;
      this.liquid.instance.setOption(this.liquid.option);
    },

    refreshLine() {
      let data = [];

      try {
        let obj = this.vm.detail[0];

        for (let i = 0; i < 24; i++) {
          data.push(obj["h" + i]);
        }
      } catch (error) {
        console.log(error);
      }

      this.line.option.series[0].data = data;
      this.line.instance.setOption(this.line.option);
    },

    resize() {
      this.$store.commit("set_Map3d_Max", !this.Map3d_Max);
    },

    tick() {
      setInterval(() => {
        this.currentTime = new Date();
      }, 5000);
    },
  },

  computed: {
    ...mapState({
      Map3d_Max: (state) => state.Map3d_Max,
    }),

    chaoList() {
      const obj = this.vm.overview[0];

      if (obj) {
        return [1, 2, 3, 4].map((n) => {
          return {
            icon:
              obj[`tide_lowhigh${n}`].indexOf("�?") >= 0
                ? "icon-gao"
                : "icon-di",
            name: obj[`tide_lowhigh${n}`],
            time: obj[`tide_time${n}`],
            value: obj[`tide_height${n}`],
          };
        });
      } else {
        return [];
      }
    },
  },

  mounted() {
    setTimeout(() => {
      this.liquid.instance = echarts.init(this.$refs.liquid);
      this.line.instance = echarts.init(this.$refs.line);
      this.refresh();
    }, 300);

    this.tick();
  },
};
</script>

<style scoped lang="scss">
.time-box {
  position: absolute;
  display: flex;
  width: 2rem;
  left: 50%;
  top: 0.46rem;
  justify-content: space-around;
  align-items: center;
  transform: translateX(calc(-50% - 0.3rem));
  font-weight: bold;
  font-size: 0.15rem;
}

.left-title {
  .cls-1 {
    fill: #060e14;
  }

  .cls-2 {
    mask: url(#mask_left-title);
  }

  .cls-3 {
    opacity: 0.55;
  }

  .cls-4 {
    fill: #1057bf;
  }

  .cls-5 {
    filter: url(#luminosity-invert_left-title);
  }

  position: absolute;
  left: 3px;
  top: 0.1rem;

  svg {
    width: 1.3rem;
  }

  span {
    position: absolute;
    left: 0;
    top: -0.07rem;
    font-weight: bold;
    font-size: 0.18rem;
    text-indent: 0.1rem;
    letter-spacing: 0.01rem;
  }
}

.resize-btn {
  position: absolute;
  right: 0.2rem;
  bottom: 0.2rem;
  cursor: pointer;
  z-index: 2;
}

.resize-btn i {
  color: rgb(160, 163, 165) !important;
}

.chaogao {
  position: absolute;
  right: 0.1rem;
  bottom: 0.1rem;
  height: 1.4rem;
  width: 6.5rem;
}

.box {
  background: rgba(23, 30, 39, 0.8);
  border: 0.01rem solid rgb(41, 114, 162);
  border-radius: 0.08rem;
  box-shadow: inset 0 0 0.08rem 0.06rem rgb(8, 61, 96);
  overflow: hidden;
  display: flex;
  width: 6.5rem;
  height: 1.4rem;
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  left: 0;
  padding: 0.1rem 0.2rem;
  justify-content: space-around;
}

.box .left {
  width: 1.8rem;
}

.box .left .title {
  font-size: 0.16rem;
  font-weight: bold;
  margin-bottom: 0.05rem;
}

.box .left ul {
  display: flex;
  flex-direction: column;
  align-items: left;
  justify-content: space-around;
  height: calc(100% - 0.2rem);
  li {
    font-size: 0.12rem;
    i {
      font-size: 0.12rem;
      margin-right: 0.04rem;
    }

    span {
      display: inline-block;
      margin-right: 0.2rem;
      &:last-child {
        margin-right: 0;
      }
    }
  }
}

.box .center {
  height: 100%;
  width: calc(100% - 3rem);
  .chart {
    width: 100%;
    height: 100%;
  }
}

.box .right {
  border-left: 0.01rem solid rgb(55, 86, 110);
  width: 1.2rem;
}

.box .close-btn {
  position: absolute;
  z-index: 2;
  right: 0.15rem;
  top: 0.1rem;
  cursor: pointer;
}

.box .close-btn i {
  color: rgb(184, 228, 255) !important;
  font-size: 0.12rem;
}

.liquid {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 1.4rem;
  height: 1.4rem;
  z-index: 1;
}

.body {
  width: 100%;
  height: 100%;
  background: rgb(26, 60, 84);
}

.header {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 70%;
}

.footer {
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 3rem;
  z-index: 2;
}

.footer-items {
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 3rem;
  display: flex;
  height: 0.4rem;
  align-items: center;
}

.footer-item {
  width: 50%;
  text-align: center;
  height: 0.4rem;
  line-height: 0.4rem;
  position: relative;
  cursor: pointer;
  /*border-right: .01rem solid rgb(70,93,112);*/
}

.footer-item:after {
  content: "";
  width: 0.02rem;
  height: 70%;
  position: absolute;
  right: 0;
  top: 50%;
  background: rgb(70, 93, 112);
  transform: translateY(-50%);
}

.footer-item:last-child:after {
  display: none;
}

.footer-item * {
  color: rgb(113, 118, 119);
  display: inline-block;
}

.footer-item span {
  margin-left: 0.06rem;
  font-weight: bold;
}

.footer-item.active * {
  color: rgb(84, 179, 255);
  /*text-shadow: 0 0 .08rem .06rem rgba(84,179,255,1);*/
}

.footer-item.active i {
  background-image: linear-gradient(
    to right,
    rgb(71, 187, 254),
    rgb(29, 143, 234)
  );
  -webkit-background-clip: text;
  color: transparent;
}

.footer-item.active i,
.footer-item.active span {
  text-shadow: 0 0 0.08rem 0.06rem rgba(84, 179, 255, 1);
  /*background-image: linear-gradient(to top,rgba(84,179,255,.2),rgba(84,179,255,0))*/
}
</style>